<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aygün AVM | Fiyat Listesi</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png"> <style>
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
        header { background: #111; color: white; padding: 15px; text-align: center; font-weight: bold; }
        .controls { padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; background: #fff; border-bottom: 1px solid #ddd; }
        #search { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #markaFilter { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .logout-btn { background: #d9534f; color: white; }
        .table-container { overflow-x: auto; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
        th { background: #f8f8f8; position: sticky; top: 0; }
        .version { font-size: 11px; color: #888; text-align: center; padding: 20px; }
        
        /* Giriş Ekranı */
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:1000; display:flex; align-items:center; justify-content:center; }
        .login-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 280px; text-align: center; }
        .login-card input { padding: 12px; margin-bottom: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .login-card button { background:#007bff; color: white; width: 100%; }
    </style>
</head>
<body>

<div id="loginOverlay" style="display:none;">
    <div class="login-card">
        <h3>Aygün AVM Giriş</h3>
        <input type="text" id="userInput" placeholder="Kullanıcı Adı">
        <input type="password" id="passInput" placeholder="Şifre">
        <button onclick="checkLogin()">Giriş Yap</button>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <header>Aygün AVM Fiyat Listesi</header>
    <div class="controls">
        <select id="markaFilter"><option value="">Tüm Markalar</option></select>
        <input type="text" id="search" placeholder="Ürün ara...">
        <button class="logout-btn" onclick="logout()">Çıkış</button>
    </div>
    <div class="table-container">
        <table>
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
    <div class="version" id="version"></div>
</div>

<script>
let allData = [];
const formatColumns = ["4T AWM", "Tek Çekim", "Nakit"]; 

function checkAuth() {
    if (localStorage.getItem("isLoggedIn") !== "true") {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("loginOverlay").style.display = "flex";
    } else {
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loginOverlay").style.display = "none";
        loadData();
    }
}

async function checkLogin() {
    const userVal = document.getElementById("userInput").value;
    const passVal = document.getElementById("passInput").value;
    try {
        const res = await fetch("data/kullanicilar.json?t=" + Date.now());
        const users = await res.json();
        const found = users.find(u => u.Kullanici === userVal && u.Sifre.toString() === passVal);
        if (found) {
            localStorage.setItem("isLoggedIn", "true");
            location.reload();
        } else { alert("Hatalı bilgiler!"); }
    } catch (e) { alert("Bağlantı hatası!"); }
}

function logout() {
    localStorage.removeItem("isLoggedIn");
    location.reload();
}

function formatPrice(val) {
    if (!val || isNaN(val)) return val;
    return Number(val).toLocaleString('tr-TR');
}

async function loadData(){
    try {
        const res = await fetch("data/urunler.json?v=" + Date.now());
        const json = await res.json();
        allData = json.data || [];
        document.getElementById("version").innerText = "Güncelleme: " + (json.metadata?.v || "");
        buildTable(allData);
        buildFilter(allData);
    } catch(e) { console.error(e); }
}

function buildTable(data){
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    thead.innerHTML = ""; tbody.innerHTML = "";
    if(!data.length) return;
    const keys = Object.keys(data[0]);
    keys.forEach(k => { const th = document.createElement("th"); th.innerText = k; thead.appendChild(th); });
    data.forEach(row => {
        const tr = document.createElement("tr");
        keys.forEach(k => {
            const td = document.createElement("td");
            td.innerText = formatColumns.includes(k) ? formatPrice(row[k]) : row[k];
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function buildFilter(data){
    const sel = document.getElementById("markaFilter");
    sel.innerHTML = '<option value="">Tüm Markalar</option>';
    const brands = [...new Set(data.map(u=>u.Marka))].filter(x=>x).sort();
    brands.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b; opt.textContent = b; sel.appendChild(opt);
    });
    sel.onchange = filterTable;
    document.getElementById("search").oninput = filterTable;
}

function filterTable(){
    const text = document.getElementById("search").value.toLowerCase();
    const marka = document.getElementById("markaFilter").value;
    const filtered = allData.filter(u => {
        const mText = Object.values(u).join(" ").toLowerCase().includes(text);
        const mBrand = !marka || u.Marka === marka;
        return mText && mBrand;
    });
    buildTable(filtered);
}

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => { navigator.serviceWorker.register('service-worker.js'); });
}
checkAuth();
</script>
</body>
</html>
