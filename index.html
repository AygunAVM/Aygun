<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AygÃ¼n AVM | Fiyat Listesi</title>
    <style>
        :root { --primary: #007bff; --dark: #212529; --success: #28a745; --danger: #dc3545; --light: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #eaeff5; margin: 0; padding: 10px; color: #333; }
        
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 1200px; margin: auto; }
        #loginArea { max-width: 350px; text-align: center; margin-top: 10vh; }
        
        input, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .hidden { display: none; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 10px; }
        
        /* Mobil Uyumlu Tablo */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th { background: var(--dark); color: white; padding: 12px 8px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px 8px; border-bottom: 1px solid #f2f2f2; }
        tr:nth-child(even) { background-color: #fafafa; }
        
        .stok-yok { color: var(--danger); font-weight: bold; background-color: #fff0f0 !important; }
        .nakit-vurgu { color: var(--success); font-weight: bold; font-size: 14px; }
        
        /* Filtre ButonlarÄ± */
        .filter-buttons { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .filter-buttons button { width: auto; padding: 6px 12px; background: #e0e0e0; color: #444; font-size: 12px; border-radius: 20px; }
        .filter-buttons button.active { background: var(--primary); color: white; }
        
        #arama { border: 2px solid var(--primary); outline: none; }
        .v-info { font-size: 10px; color: #888; text-align: right; }
        
        @media (max-width: 600px) {
            body { padding: 5px; }
            .card { padding: 12px; }
            th, td { padding: 8px 5px; font-size: 12px; }
            .nakit-vurgu { font-size: 12px; }
        }
    </style>
</head>
<body>

<div id="loginArea" class="card">
    <h2 style="color: var(--primary)">AygÃ¼n AVM</h2>
    <p>Fiyat Listesi GiriÅŸi</p>
    <input type="text" id="email" placeholder="E-posta">
    <input type="password" id="sifre" placeholder="Åžifre">
    <button onclick="girisYap()">GÄ°RÄ°Åž YAP</button>
</div>

<div id="app" class="card hidden">
    <div class="header-row">
        <h3 style="margin:0">ÃœrÃ¼n Listesi</h3>
        <button onclick="cikisYap()" style="width:auto; background:var(--danger); padding:6px 12px; font-size:12px;">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
    
    <input type="text" id="arama" placeholder="ðŸ” Model, Kod veya AÃ§Ä±klama ara..." onkeyup="tabloyuCiz()">
    
    <div id="gamiFiltre" class="filter-buttons"></div>
    <input type="hidden" id="aktifGam" value="">

    <div class="table-container">
        <table id="urunTablosu">
            <thead>
                <tr>
                    <th>Kod</th>
                    <th>Stok</th>
                    <th>4T Fiyat</th>
                    <th>Tek Ã‡ekim</th>
                    <th>Nakit</th>
                    <th>ÃœrÃ¼n GamÄ±</th>
                    <th>AÃ§Ä±klama</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="v-info" id="guncelleme"></div>
</div>

<script>
let tumUrunler = [];
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 Dakika

window.onload = function() {
    checkSession();
};

function checkSession() {
    const authData = JSON.parse(localStorage.getItem("aygun_auth_v2") || "null");
    if (authData && (Date.now() - authData.time < SESSION_TIMEOUT)) {
        appiAc();
    } else {
        localStorage.removeItem("aygun_auth_v2");
        document.getElementById("loginArea").classList.remove("hidden");
    }
}

async function girisYap() {
    const mail = document.getElementById("email").value.trim().toLowerCase();
    const pass = document.getElementById("sifre").value.trim();

    try {
        const r = await fetch('data/kullanicilar.json?cache=' + Date.now());
        const users = await r.json();

        const user = users.find(u => String(u.Email).toLowerCase() === mail && String(u.Sifre) === pass);

        if(user) {
            const session = { auth: true, time: Date.now(), user: mail };
            localStorage.setItem("aygun_auth_v2", JSON.stringify(session));
            appiAc();
        } else {
            alert("HatalÄ± kullanÄ±cÄ± veya ÅŸifre!");
        }
    } catch(e) {
        alert("BaÄŸlantÄ± hatasÄ±! LÃ¼tfen internetinizi veya JSON dosyasÄ±nÄ± kontrol edin.");
    }
}

function appiAc() {
    document.getElementById("loginArea").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    veriyiGetir();
}

function cikisYap() {
    localStorage.removeItem("aygun_auth_v2");
    location.reload();
}

async function veriyiGetir() {
    try {
        const r = await fetch('data/urunler.json?v=' + Date.now());
        const res = await r.json();
        
        // HATA Ã–NLEME: Verinin dizi olduÄŸundan emin ol
        tumUrunler = Array.isArray(res.data) ? res.data : [];
        
        document.getElementById("guncelleme").innerText = "Son GÃ¼ncelleme: " + (res.metadata?.v || "Bilinmiyor");
        
        // Dinamik Filtre ButonlarÄ±
        const alan = document.getElementById("gamiFiltre");
        alan.innerHTML = '<button id="btn-hepsi" onclick="filtreleGam(\'\')" class="active">Hepsi</button>';
        
        const gamlar = [...new Set(tumUrunler.map(u => u.UrunGami).filter(Boolean))];
        gamlar.forEach(g => {
            const btn = document.createElement("button");
            btn.innerText = g;
            btn.onclick = (e) => {
                document.querySelectorAll('.filter-buttons button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                filtreleGam(g);
            };
            alan.appendChild(btn);
        });

        tabloyuCiz();
    } catch(e) {
        console.error("Veri Ã§ekme hatasÄ±:", e);
    }
}

function filtreleGam(g) {
    document.getElementById("aktifGam").value = g;
    tabloyuCiz();
}

function tabloyuCiz() {
    const arama = document.getElementById("arama").value.toLowerCase();
    const gam = document.getElementById("aktifGam").value;
    const tbody = document.querySelector("#urunTablosu tbody");
    tbody.innerHTML = "";

    // Filtreleme iÅŸlemi
    const sÃ¼zÃ¼lmÃ¼ÅŸ = tumUrunler.filter(u => {
        const mGam = !gam || u.UrunGami === gam;
        const text = (u.Kod + " " + (u.Aciklama||"") + " " + (u.TicariKod||"")).toLowerCase();
        const mAra = text.includes(arama);
        return mGam && mAra && u.Kod; // Sadece kodu olanlarÄ± gÃ¶ster (boÅŸ satÄ±rlarÄ± ele)
    });

    sÃ¼zÃ¼lmÃ¼ÅŸ.forEach(u => {
        const tr = document.createElement("tr");
        if(parseInt(u.Stok) <= 0) tr.classList.add("stok-yok");

        tr.innerHTML = `
            <td><b>${u.Kod}</b><br><small style="color:gray">${u.TicariKod||''}</small></td>
            <td>${u.Stok || 0}</td>
            <td>${para(u.T4AMW)}</td>
            <td>${para(u.TekCekim)}</td>
            <td class="nakit-vurgu">${para(u.Nakit)}</td>
            <td><small>${u.UrunGami || '-'}</small></td>
            <td style="white-space: normal; min-width: 150px; font-size: 11px;">${u.Aciklama || ''}</td>
        `;
        tbody.appendChild(tr);
    });
}

function para(v) {
    if(!v || isNaN(v) || v == 0) return "-";
    return Number(v).toLocaleString("tr-TR") + " â‚º";
}
</script>
</body>
</html>
