<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Aygün AVM Fiyat Listesi</title>
<style>
body{font-family:Arial;background:#f4f4f4;margin:0;padding:20px}
.container{max-width:1200px;margin:auto}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
input{padding:8px;margin:5px 0;width:100%;box-sizing:border-box}
button{padding:8px 15px;border:none;border-radius:5px;background:#007bff;color:#fff;cursor:pointer}
button:hover{background:#0056b3}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:8px;border:1px solid #ddd;text-align:left;font-size:13px}
th{background:#007bff;color:#fff}
.stok-kirmizi{background:#ffdddd}
.stok-yesil{background:#ddffdd}
.hidden{display:none}
.topbar{display:flex;justify-content:space-between;align-items:center}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<div class="container">

<div id="loginCard" class="card">
<h2>Giriş Yap</h2>
<input type="text" id="email" placeholder="Mail adresi">
<input type="password" id="password" placeholder="Şifre">
<button onclick="login()">Giriş</button>
<p id="loginError" style="color:red"></p>
</div>

<div id="mainApp" class="hidden">
<div class="card">
<div class="topbar">
<h2>Fiyat Listesi</h2>
<div>
<button onclick="showChangePass()">Şifre Değiştir</button>
<button onclick="logout()">Çıkış</button>
</div>
</div>

<input type="text" id="search" placeholder="Kod, Ticari Kod, Açıklama, Ürün Gamı ara..." onkeyup="renderTable()">

<table id="urunTable">
<thead>
<tr>
<th>Kod</th>
<th>Ticari Kod</th>
<th>Stok</th>
<th>4T</th>
<th>Tek Çekim</th>
<th>Nakit</th>
<th>Ürün Gamı</th>
<th>Açıklama</th>
</tr>
</thead>
<tbody></tbody>
</table>
<p class="small">Versiyon: <span id="version"></span></p>
</div>
</div>

<div id="changePassCard" class="card hidden">
<h3>Şifre Değiştir</h3>
<input type="password" id="newPass" placeholder="Yeni şifre">
<button onclick="changePassword()">Kaydet</button>
<button onclick="hideChangePass()">İptal</button>
<p id="changeInfo" class="small"></p>
</div>

</div>

<script>
let users=[]
let products=[]
let currentUser=null

fetch("data/kullanicilar.json")
.then(r=>r.json())
.then(data=>users=data)

fetch("data/urunler.json")
.then(r=>r.json())
.then(data=>{
products=data
document.getElementById("version").innerText=new Date().toLocaleString()
})

function login(){
let email=document.getElementById("email").value.trim()
let pass=document.getElementById("password").value.trim()
let error=document.getElementById("loginError")

let lock=localStorage.getItem("lock_"+email)
if(lock==="true"){
error.innerText="Hesap kilitli!"
return
}

let user=users.find(u=>u.Email.toLowerCase()===email.toLowerCase())
if(!user){ error.innerText="Kullanıcı yok"; return }

let localPass=localStorage.getItem("pass_"+email)
let truePass=localPass?localPass:user.Sifre

if(pass===truePass){
currentUser=email
document.getElementById("loginCard").classList.add("hidden")
document.getElementById("mainApp").classList.remove("hidden")
renderTable()
}else{
let attempts=Number(localStorage.getItem("attempt_"+email))||0
attempts++
localStorage.setItem("attempt_"+email,attempts)
if(attempts>=3){
localStorage.setItem("lock_"+email,"true")
error.innerText="3 Hatalı giriş. Hesap kilitlendi."
}else{
error.innerText="Şifre yanlış"
}
}
}

function logout(){
location.reload()
}

function renderTable(){
let search=document.getElementById("search").value.toLowerCase()
let tbody=document.querySelector("#urunTable tbody")
tbody.innerHTML=""

products
.filter(p=>
p.Kod.toLowerCase().includes(search)||
p.TicariKod.toLowerCase().includes(search)||
p.Aciklama.toLowerCase().includes(search)||
p.UrunGami.toLowerCase().includes(search)
)
.forEach(p=>{
let tr=document.createElement("tr")

if(p.Stok==0) tr.classList.add("stok-kirmizi")
if(p.Stok>8) tr.classList.add("stok-yesil")

tr.innerHTML=`
<td>${p.Kod}</td>
<td>${p.TicariKod}</td>
<td>${p.Stok}</td>
<td>${format(p.Taksit4)}</td>
<td>${format(p.TekCekim)}</td>
<td>${format(p.Nakit)}</td>
<td>${p.UrunGami}</td>
<td>${p.Aciklama}</td>
`
tbody.appendChild(tr)
})
}

function format(x){
return Number(x).toLocaleString("tr-TR")
}

function showChangePass(){
document.getElementById("changePassCard").classList.remove("hidden")
}

function hideChangePass(){
document.getElementById("changePassCard").classList.add("hidden")
}

function changePassword(){
let newPass=document.getElementById("newPass").value
if(!newPass){ return }
localStorage.setItem("pass_"+currentUser,newPass)
document.getElementById("changeInfo").innerText="Şifre değiştirildi (Excel güncellenene kadar geçici)"
}

</script>
</body>
</html>