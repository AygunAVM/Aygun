<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aygün AVM Fiyat Listesi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; color:#333; }
header { display:flex; justify-content:space-between; align-items:center; padding:15px; background:#fff; border-bottom:2px solid #007bff; }
#versiyon { font-weight:bold; color:#007bff; }
.controls { padding:10px; display:flex; gap:8px; flex-wrap:wrap; background:#fff; border-bottom:1px solid #ddd; }
#search { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
#markaFilter { padding:8px; border:1px solid #ccc; border-radius:4px; }
table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
th, td { padding:10px; border:1px solid #ddd; text-align:left; }
th { background:#f0f0f0; position:sticky; top:0; z-index:1; }
tr:nth-child(even) { background:#fafafa; }
</style>
</head>
<body>

<header>
    <span id="versiyon">Yükleniyor...</span>
    <h3>Aygün AVM Fiyat Listesi</h3>
</header>

<div class="controls">
    <select id="markaFilter"><option value="">Tüm Markalar</option></select>
    <input type="text" id="search" placeholder="Ürün, marka veya model ara...">
</div>

<div style="overflow-x:auto; padding:10px;">
    <table id="urunTable">
        <thead></thead>
        <tbody></tbody>
    </table>
</div>

<script>
let allData = [];
const formatColumns = ["4T AWM", "Tek Çekim", "Nakit"]; // Nokta formatlanacak sütunlar

// JSON yükleme
async function loadData(){
    try {
        const res = await fetch("data/urunler.json?v=" + Date.now());
        const json = await res.json();
        allData = json.data || [];
        
        // Versiyon sol üstte
        document.getElementById("versiyon").innerText = json.metadata?.v || "V0";

        buildFilter(allData);
        buildTable(allData);
    } catch(e) { 
        console.error("Veri yüklenemedi", e);
        document.getElementById("versiyon").innerText = "Veri Yok";
    }
}

// Tablo oluşturma
function buildTable(data){
    const thead = document.querySelector("#urunTable thead");
    const tbody = document.querySelector("#urunTable tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";
    if(!data.length) return;

    const keys = Object.keys(data[0]);
    let headerRow = "<tr>";
    keys.forEach(k => headerRow += "<th>"+k+"</th>");
    headerRow += "</tr>";
    thead.innerHTML = headerRow;

    let bodyRows = "";
    data.forEach(row=>{
        bodyRows += "<tr>";
        keys.forEach(k=>{
            let val = row[k];
            if(formatColumns.includes(k)) val = Number(val).toLocaleString('tr-TR');
            bodyRows += "<td>"+(val ?? "")+"</td>";
        });
        bodyRows += "</tr>";
    });
    tbody.innerHTML = bodyRows;
}

// Marka filtresi
function buildFilter(data){
    const sel = document.getElementById("markaFilter");
    const brands = [...new Set(data.map(u=>u.Marka))].filter(x=>x).sort();
    brands.forEach(b=>{
        const opt = document.createElement("option");
        opt.value=b; opt.textContent=b;
        sel.appendChild(opt);
    });
}

function filterTable(){
    const text = document.getElementById("search").value.toLowerCase();
    const marka = document.getElementById("markaFilter").value;
    const filtered = allData.filter(u=>{
        const matchText = Object.values(u).join(" ").toLowerCase().includes(text);
        const matchBrand = !marka || u.Marka === marka;
        return matchText && matchBrand;
    });
    buildTable(filtered);
}

document.getElementById("search").addEventListener("input", filterTable);
document.getElementById("markaFilter").addEventListener("change", filterTable);

// Service Worker
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
}

// Başlangıç
loadData();
</script>
</body>
</html>
